var e,t;window.ue4=(e=function(e,t){if("function"!=typeof e)return"";var n="10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}));return ue.interface[n]=e,setTimeout((function(){delete ue.interface[n]}),1e3*Math.max(1,parseInt(t)||0)),n},"object"!=typeof window.ue&&(window.ue={}),"object"!=typeof ue.interface||"function"!=typeof ue.interface.broadcast?(ue.interface={},function(t,n,i,o){var a,s;"string"==typeof t&&("function"==typeof n&&(o=i,i=n,n=null),a=[t,"",e(i,o)],void 0!==n&&(a[1]=n),s=encodeURIComponent(JSON.stringify(a)),"object"==typeof history&&"function"==typeof history.pushState?(history.pushState({},"","#"+s),history.pushState({},"","#"+encodeURIComponent("[]"))):(document.location.hash=s,document.location.hash=encodeURIComponent("[]")))}):(t=ue.interface,ue.interface={},function(n,i,o,a){var s;"string"==typeof n&&("function"==typeof i&&(a=o,o=i,i=null),s=e(o,a),void 0!==i?t.broadcast(n,JSON.stringify(i),s):t.broadcast(n,"",s))}));function n(e){e=void 0!==e?e:{};var t=this;console.log("在webRtcPlayer函数中运行","parOptions:",e,"\n","window.location:",window.location,"\n","self:",t),this.cfg=void 0!==e.peerConnectionOptions?e.peerConnectionOptions:{},this.cfg.sdpSemantics="unified-plan",this.cfg.offerExtmapAllowMixed=!1,this.pcClient=null,this.dcClient=null,this.tnClient=null,this.sdpConstraints={offerToReceiveAudio:1,offerToReceiveVideo:1,voiceActivityDetection:!1},this.dataChannelOptions={ordered:!0},this.startVideoMuted=void 0!==e.startVideoMuted&&e.startVideoMuted,this.autoPlayAudio=void 0===e.autoPlayAudio||e.autoPlayAudio;const n=new URLSearchParams(window.location.search);this.useMic=n.has("useMic"),this.useMic||console.log("Microphone access is not enabled. Pass ?useMic in the url to enable it.");let i="localhost"===location.hostname||"127.0.0.1"===location.hostname,o="https:"===location.protocol;!this.useMic||i||o||(this.useMic=!1,console.error("Microphone access in the browser will not work if you are not on HTTPS or localhost. Disabling mic access."),console.error("For testing you can enable HTTP microphone access Chrome by visiting chrome://flags/ and enabling 'unsafely-treat-insecure-origin-as-secure'")),this.latencyTestTimings={TestStartTimeMs:null,UEReceiptTimeMs:null,UEPreCaptureTimeMs:null,UEPostCaptureTimeMs:null,UEPreEncodeTimeMs:null,UEPostEncodeTimeMs:null,UETransmissionTimeMs:null,BrowserReceiptTimeMs:null,FrameDisplayDeltaTimeMs:null,Reset:function(){this.TestStartTimeMs=null,this.UEReceiptTimeMs=null,this.UEPreCaptureTimeMs=null,this.UEPostCaptureTimeMs=null,this.UEPreEncodeTimeMs=null,this.UEPostEncodeTimeMs=null,this.UETransmissionTimeMs=null,this.BrowserReceiptTimeMs=null,this.FrameDisplayDeltaTimeMs=null},SetUETimings:function(e){this.UEReceiptTimeMs=e.ReceiptTimeMs,this.UEPreCaptureTimeMs=e.PreCaptureTimeMs,this.UEPostCaptureTimeMs=e.PostCaptureTimeMs,this.UEPreEncodeTimeMs=e.PreEncodeTimeMs,this.UEPostEncodeTimeMs=e.PostEncodeTimeMs,this.UETransmissionTimeMs=e.TransmissionTimeMs,this.BrowserReceiptTimeMs=Date.now(),this.OnAllLatencyTimingsReady(this)},SetFrameDisplayDeltaTime:function(e){null==this.FrameDisplayDeltaTimeMs&&(this.FrameDisplayDeltaTimeMs=Math.round(e),this.OnAllLatencyTimingsReady(this))},OnAllLatencyTimingsReady:function(e){}},this.createWebRtcVideo=function(){var e=document.getElementById("streamingVideo");if(e.muted="muted",e.disablepictureinpicture=!0,e.addEventListener("loadedmetadata",(function(e){t.onVideoInitialised&&t.onVideoInitialised()}),!0),"requestVideoFrameCallback"in HTMLVideoElement.prototype){const n=(i,o)=>{if(o.receiveTime&&o.expectedDisplayTime){const e=o.presentationTime-o.receiveTime;t.aggregatedStats.receiveToCompositeMs=e}e.requestVideoFrameCallback(n)};e.requestVideoFrameCallback(n)}return e},this.video=this.createWebRtcVideo();let a=function(e){console.info("signaling state change:",e)},s=function(e){console.info("ice connection state change:",e)},r=function(e){console.info("ice gathering state change:",e)},l=function(e){return console.log("handleOnTrack",e.streams),console.log("🚀 🚀 🚀 🚀 🚀 🚀 e",e),console.log("🚀 🚀 🚀 🚀 🚀 🚀 self.video.srcObject ",t.video,t.video.srcObject),e.track&&console.log("Got track - "+e.track.kind+" id="+e.track.id+" readyState="+e.track.readyState),"audio"==e.track.kind?(console.log("🚀 ~ file: webRtcPlayer.js:207 ~ handleOnTrack ~ e.track.kind",e.track),void c(e.streams[0])):("video"==e.track.kind&&(t.video.srcObject,e.streams[0]),t.video.srcObject=e.streams[0],void console.log("Set video source from video track ontrack."))},c=function(e){if(t.video.srcObject!=e&&t.video.srcObject&&t.video.srcObject!==e){let n=document.createElement("Audio");if(n.srcObject=e,console.log("self ",t),!t.autoPlayAudio){let e=function(){n.play(),t.video.removeEventListener("click",e)};t.video.addEventListener("click",e)}console.log("Created new audio element to play seperate audio stream.")}},d=function(e){console.log("ICE candidate",e),e.candidate&&e.candidate.candidate&&t.onWebRtcCandidate(e.candidate)},u=function(e){e.sdp=e.sdp.replace("useinbandfec=1","useinbandfec=1;stereo=1;sprop-maxcapturerate=48000")};this.setVideoEnabled=function(e){t.video.srcObject.getTracks().forEach((t=>t.enabled=e))},this.startLatencyTest=function(e){t.video&&(t.latencyTestTimings.Reset(),t.latencyTestTimings.TestStartTimeMs=Date.now(),e(t.latencyTestTimings.TestStartTimeMs))},this.handleCandidateFromServer=function(e){console.log("ICE candidate: ",e);let n=new RTCIceCandidate(e);t.pcClient.addIceCandidate(n).then((e=>{console.log("ICE candidate successfully added")}))},this.createOffer=function(){t.pcClient&&(console.log("Closing existing PeerConnection"),t.pcClient.close(),t.pcClient=null),t.pcClient=new RTCPeerConnection(t.cfg),async function(e){if(e.addTransceiver("video",{direction:"recvonly"}),t.useMic){let n=!!t.useMic&&{autoGainControl:!1,channelCount:1,echoCancellation:!1,latency:0,noiseSuppression:!1,sampleRate:16e3,volume:1};const i=await navigator.mediaDevices.getUserMedia({video:!1,audio:n});if(i)for(const t of i.getTracks())t.kind&&"audio"==t.kind&&e.addTransceiver(t,{direction:"sendrecv"});else e.addTransceiver("audio",{direction:"recvonly"})}else e.addTransceiver("audio",{direction:"recvonly"})}(t.pcClient).finally((function(){var e;(e=t.pcClient).SetBitrate&&console.log("Hurray! there's RTCPeerConnection.SetBitrate function"),e.onsignalingstatechange=a,e.oniceconnectionstatechange=s,e.onicegatheringstatechange=r,e.ontrack=l,e.onicecandidate=d,t.dcClient=function(e,n,i){try{let o=e.createDataChannel(n,i);return console.log(`Created datachannel (${n})`),o.binaryType="arraybuffer",o.onopen=function(e){console.log(`data channel (${n}) connect`),t.onDataChannelConnected&&t.onDataChannelConnected()},o.onclose=function(e){console.log(`data channel (${n}) closed`)},o.onmessage=function(e){t.onDataChannelMessage&&t.onDataChannelMessage(e.data)},o}catch(e){return console.warn("No data channel",e),null}}(t.pcClient,"cirrus",t.dataChannelOptions),function(e){e.createOffer(t.sdpConstraints).then((function(n){u(n),e.setLocalDescription(n),t.onWebRtcOffer&&t.onWebRtcOffer(n)}),(function(){console.warn("Couldn't create offer")}))}(t.pcClient)}))},this.receiveAnswer=function(e){console.log("Received answer:"),console.log(e);var n=new RTCSessionDescription(e);t.pcClient.setRemoteDescription(n);let i=t.pcClient.getReceivers();for(let e of i)e.playoutDelayHint=0},this.close=function(){t.pcClient&&(console.log("Closing existing peerClient"),t.pcClient.close(),t.pcClient=null),t.aggregateStatsIntervalId&&clearInterval(t.aggregateStatsIntervalId)},this.send=function(e){t.dcClient&&"open"==t.dcClient.readyState&&t.dcClient.send(e)},this.getStats=function(e){t.pcClient&&e&&t.pcClient.getStats(null).then((t=>{e(t)}))},this.aggregateStats=function(e){let n=(t.aggregatedStats||(t.aggregatedStats={}),function(e){let n={};e.forEach((e=>{"inbound-rtp"!=e.type||e.isRemote||"video"!=e.mediaType&&!e.id.toLowerCase().includes("video")||(n.timestamp=e.timestamp,n.bytesReceived=e.bytesReceived,n.framesDecoded=e.framesDecoded,n.packetsLost=e.packetsLost,n.bytesReceivedStart=t.aggregatedStats&&t.aggregatedStats.bytesReceivedStart?t.aggregatedStats.bytesReceivedStart:e.bytesReceived,n.framesDecodedStart=t.aggregatedStats&&t.aggregatedStats.framesDecodedStart?t.aggregatedStats.framesDecodedStart:e.framesDecoded,n.timestampStart=t.aggregatedStats&&t.aggregatedStats.timestampStart?t.aggregatedStats.timestampStart:e.timestamp,t.aggregatedStats&&t.aggregatedStats.timestamp&&(t.aggregatedStats.bytesReceived&&(n.bitrate=8*(n.bytesReceived-t.aggregatedStats.bytesReceived)/(n.timestamp-t.aggregatedStats.timestamp),n.bitrate=Math.floor(n.bitrate),n.lowBitrate=t.aggregatedStats.lowBitrate&&t.aggregatedStats.lowBitrate<n.bitrate?t.aggregatedStats.lowBitrate:n.bitrate,n.highBitrate=t.aggregatedStats.highBitrate&&t.aggregatedStats.highBitrate>n.bitrate?t.aggregatedStats.highBitrate:n.bitrate),t.aggregatedStats.bytesReceivedStart&&(n.avgBitrate=8*(n.bytesReceived-t.aggregatedStats.bytesReceivedStart)/(n.timestamp-t.aggregatedStats.timestampStart),n.avgBitrate=Math.floor(n.avgBitrate)),t.aggregatedStats.framesDecoded&&(n.framerate=(n.framesDecoded-t.aggregatedStats.framesDecoded)/((n.timestamp-t.aggregatedStats.timestamp)/1e3),n.framerate=Math.floor(n.framerate),n.lowFramerate=t.aggregatedStats.lowFramerate&&t.aggregatedStats.lowFramerate<n.framerate?t.aggregatedStats.lowFramerate:n.framerate,n.highFramerate=t.aggregatedStats.highFramerate&&t.aggregatedStats.highFramerate>n.framerate?t.aggregatedStats.highFramerate:n.framerate),t.aggregatedStats.framesDecodedStart&&(n.avgframerate=(n.framesDecoded-t.aggregatedStats.framesDecodedStart)/((n.timestamp-t.aggregatedStats.timestampStart)/1e3),n.avgframerate=Math.floor(n.avgframerate)))),"track"!=e.type||"video_label"!=e.trackIdentifier&&"video"!=e.kind||(n.framesDropped=e.framesDropped,n.framesReceived=e.framesReceived,n.framesDroppedPercentage=e.framesDropped/e.framesReceived*100,n.frameHeight=e.frameHeight,n.frameWidth=e.frameWidth,n.frameHeightStart=t.aggregatedStats&&t.aggregatedStats.frameHeightStart?t.aggregatedStats.frameHeightStart:e.frameHeight,n.frameWidthStart=t.aggregatedStats&&t.aggregatedStats.frameWidthStart?t.aggregatedStats.frameWidthStart:e.frameWidth),"candidate-pair"==e.type&&e.hasOwnProperty("currentRoundTripTime")&&0!=e.currentRoundTripTime&&(n.currentRoundTripTime=e.currentRoundTripTime)})),t.aggregatedStats.receiveToCompositeMs&&(n.receiveToCompositeMs=t.aggregatedStats.receiveToCompositeMs,t.latencyTestTimings.SetFrameDisplayDeltaTime(t.aggregatedStats.receiveToCompositeMs)),t.aggregatedStats=n,t.onAggregatedStats&&t.onAggregatedStats(n)});t.aggregateStatsIntervalId=setInterval((()=>{t.getStats(n)}),e)}}let i={cursorStyle:"none"};document.createEvent("KeyboardEvent").initKeyboardEvent;let o,a=null;let s,r,l,c=(new Date).getTime(),d=new Map,u=null,g=!0,f={receiving:!1,size:0,jpeg:void 0,height:0,width:0,valid:!1};function m(e,t,n){let i=document.getElementById("videoPlayOverlay");if(!i){let e=document.getElementById("player");i=document.createElement("div"),i.style.position="absolute",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.id="videoPlayOverlay",e.appendChild(i)}for(;i.lastChild;)i.removeChild(i.lastChild);t&&i.appendChild(t),n&&i.addEventListener("click",(function e(t){n(t),i.removeEventListener("click",e)}));let o=i.classList;for(let e=o.length-1;e>=0;e--)o.remove(o[e]);i.classList.add(e)}function h(e){let t=document.createElement("div");t.id="messageOverlay",t.innerHTML=e||"",m("textDisplayState",t)}function p(){a&&a.video?(a.video.muted=!0,a.autoPlayAudio=!1,a.video.play().catch((function(e){console.error(e),console.log("Browser does not support autoplaying video without interaction - to resolve this we are going to show the play button overlay."),y()})),w(new Uint8Array([Y.RequestInitialSettings]).buffer),w(new Uint8Array([Y.RequestQualityControl]).buffer),V(),v()):console.error("Could not player video stream because webRtcPlayerObj.video was not valid.")}function y(){let e=document.createElement("img");e.id="playButton",e.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAGkSURBVHgBzVcBdYQwDA2nAAlMwZiCIWHnAAc3B0gAFDAHhwSmgDkoDsBBlgDduvcYNFDg/nsfyoPw07RNUw8sgYg+3d6Ir8SQGBD98XVHbIhfxE9i6XleBy5AwgExJbYoQ8G2sBbc41F4K9IxeuJeK3QHhbbRoA9DdCtuOhEe3fMpJwJT0zPEeZxqGGb3nmiIL3qVXIwXyQHiMGok+qGPwBgWBcfiiaLQ6AgktlZlWcL1eoU8z2Ej3vsrDuvdGkEQIJsxuX2/33El2n7e0SWWWGlxk3Eco1IKVyBmBwqJxZQDOhpZlqEQBTtQSyz+c8B0RBCNmh0QbTJLDgiHpQUUwtYBHY22ne/fBXZE0zRQVdXsN+yAm8JhAhQBCMPZ/adzPgmZvu9jmlqVEv0k/EABloSTJFkcdwOFk0S0Qlgj1qnY2pLFTPHb7bZG+Od3/UyghnUK457y8oqiaG361ShY+zG2Y27QbfP+KkA+ap5fkv0BnlCUTjlxXlm+YyQUSo9pOOQHcYUxAf6H7Gg2EQ1RusYhsWU2vfbAEvh7PI+Iz+DoeP4NHi73H/78C3UAAAAASUVORK5CYII=",e.style.position="abs",e.style.width="60px",e.style.height="60px",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.zIndex="100",e.style.cursor="pointer",e.style.transform="translate(-50%, -50%)",e.alt="Start Streaming",m("clickableState",e,(e=>{p()})),g=!1}function v(){m("hiddenState")}function w(e){a&&a.send(e)}const S=0,T=1,b=2,C=3,M=4,E=5,D=6,U=7;function R(e,t){function i(e){f.receiving||(f.receiving=!0,f.valid=!1,f.size=0,f.jpeg=void 0),f.size=new DataView(e.slice(1,5).buffer).getInt32(0,!0);let t=e.slice(5);if(f.jpeg){let e=new Uint8Array(f.jpeg.length+t.length);e.set(f.jpeg,0),e.set(t,f.jpeg.length),f.jpeg=e}else f.jpeg=t,f.receiving=!0,console.log(`received first chunk of freeze frame: ${f.jpeg.length}/${f.size}`);f.jpeg.length===f.size?(f.receiving=!1,f.valid=!0,console.log(`received complete freeze frame ${f.size}`),function(){let e=btoa(f.jpeg.reduce(((e,t)=>e+String.fromCharCode(t)),"")),t=document.getElementById("freezeFrameOverlay").childNodes[0];t.src="data:image/jpeg;base64,"+e,t.onload=function(){f.height=t.naturalHeight,f.width=t.naturalWidth,z(),g?(y(),F()):V(),a.setVideoEnabled(!1)}}()):f.jpeg.length>f.size&&(console.error(`received bigger freeze frame than advertised: ${f.jpeg.length}/${f.size}`),f.jpeg=void 0,f.receiving=!1)}return a=new n(t),e.appendChild(a.video),e.appendChild(u),a.onWebRtcOffer=function(e){if(o&&1===o.readyState){let t=JSON.stringify(e);console.log(`-> SS: offer:\n${t}`),o.send(t)}},a.onWebRtcCandidate=function(e){o&&1===o.readyState&&(console.log(`-> SS: iceCandidate\n${JSON.stringify(e,void 0,4)}`),o.send(JSON.stringify({type:"iceCandidate",candidate:e})))},a.onVideoInitialised=function(){o&&1===o.readyState&&(g?(y(),F()):(F(),p()))},a.onDataChannelConnected=function(){o&&1===o.readyState&&(h("WebRTC connected, waiting for video"),r&&r(),a.video&&a.video.srcObject&&a.onVideoInitialised&&a.onVideoInitialised())},a.onDataChannelMessage=function(e){let t=new Uint8Array(e);if(t[0]===S){let e=0!==t[1];console.log("Received quality controller message, will control quality: "+e)}else if(t[0]===T){!function(e){if(console.log("接收:",e),console.log(Ue(e),"isJson"),Ue(e)){let t=JSON.parse(e),n=t.eventName,i=d.get(n);i&&(console.log("callback",i),i(t.eventParam))}}(new TextDecoder("utf-16").decode(e.slice(1)))}else if(t[0]===b){let t=new TextDecoder("utf-16").decode(e.slice(1));console.log(t);let n=JSON.parse(t);"onScreenKeyboard"===n.command&&function(e){if(e.showOnScreenKeyboard){l.classList.remove("hiddenState");let t=G(e.x,e.y);l.style.top=t.y.toString()+"px",l.style.left=(t.x-40).toString()+"px"}}(n)}else if(t[0]===C)i(t);else if(t[0]===M)j();else if(t[0]===E)new TextDecoder("utf-16").decode(e.slice(1));else if(t[0]==D){let t=new TextDecoder("utf-16").decode(e.slice(1));console.log("Got latency timings from UE."),console.log(t);let n=JSON.parse(t);a&&a.latencyTestTimings.SetUETimings(n)}else t[0]==U||console.error(`unrecognized data received, packet ID ${t[0]}`)},function(e){if(!e)return;(function(e){e.onmouseenter=function(t){let n=new DataView(new ArrayBuffer(1));n.setUint8(0,Y.MouseEnter),w(n.buffer),e.pressMouseButtons(t)},e.onmouseleave=function(t){let n=new DataView(new ArrayBuffer(1));n.setUint8(0,Y.MouseLeave),w(n.buffer),e.releaseMouseButtons(t)}})(e),function(e){let t=[9,8,7,6,5,4,3,2,1,0],n={};function i(e){let i=t.pop();void 0===i&&console.log("exhausted touch indentifiers"),n[e.identifier]=i}function o(e){t.push(n[e.identifier]),delete n[e.identifier]}function a(t,i){let o=new DataView(new ArrayBuffer(2+7*i.length));o.setUint8(0,t),o.setUint8(1,i.length);let a=2;for(let t=0;t<i.length;t++){let s=i[t],r=s.clientX-e.offsetLeft,l=s.clientY-e.offsetTop,c=q(r,l);o.setUint16(a,c.x,!0),a+=2,o.setUint16(a,c.y,!0),a+=2,o.setUint8(a,n[s.identifier],!0),a+=1,o.setUint8(a,255*s.force,!0),a+=1,o.setUint8(a,c.inRange?1:0,!0),a+=1}w(o.buffer)}e.ontouchstart=function(e){for(let t=0;t<e.changedTouches.length;t++)i(e.changedTouches[t]);a(Y.TouchStart,e.changedTouches),e.preventDefault()},e.ontouchend=function(e){a(Y.TouchEnd,e.changedTouches);for(let t=0;t<e.changedTouches.length;t++)o(e.changedTouches[t]);e.preventDefault()},e.ontouchmove=function(e){a(Y.TouchMove,e.touches),e.preventDefault()}}(e)}(a.video),a?(console.log("Creating offer"),a.createOffer()):console.log("WebRTC player not setup, cannot create offer"),a.video}let A,k,B,x,I,P="default";const O=0,W=1;let H,L=W;function V(){f.valid&&(u.classList.add("freezeframeBackground"),u.style.display="block")}function j(){u.style.display="none",f.valid=!1,u.classList.remove("freezeframeBackground"),a&&a.setVideoEnabled(!0)}function z(){if(0!==f.width&&0!==f.height){let e=0,t=0,n=0,i=0,o=document.getElementById("enlarge-display-to-fill-window-tgl"),a=document.getElementById("player");if(null!==o&&o.checked){let o=window.innerWidth/window.innerHeight,a=f.width/f.height;o<a?(e=window.innerWidth,t=Math.floor(window.innerWidth/a),n=Math.floor(.5*(window.innerHeight-t)),i=0):(e=Math.floor(window.innerHeight*a),t=window.innerHeight,n=0,i=Math.floor(.5*(window.innerWidth-e)))}else{let o=a.offsetWidth/a.offsetHeight,s=f.width/f.height;o<s?(e=a.offsetWidth,t=Math.floor(a.offsetWidth/s),n=Math.floor(.5*(a.offsetHeight-t)),i=0):(e=Math.floor(a.offsetHeight*s),t=a.offsetHeight,n=0,i=Math.floor(.5*(a.offsetWidth-e)))}let s=document.getElementById("freezeFrameOverlay").childNodes[0];u.style.width=a.offsetWidth+"px",u.style.height=a.offsetHeight+"px",u.style.left="0px",u.style.top="0px",s.style.width=e+"px",s.style.height=t+"px",s.style.left=i+"px",s.style.top=n+"px"}}function F(e){let t=document.getElementById("player");if(!t)return;if($(),t.classList.contains("fixed-size"))return void N(t);let n=document.getElementById("enlarge-display-to-fill-window-tgl"),i=window.innerWidth<t.videoWidth||window.innerHeight<t.videoHeight;null!==n?n.checked||i?function(e){let t=e.getElementsByTagName("VIDEO"),n=window.innerHeight/window.innerWidth,i=e.clientHeight/e.clientWidth,o=t.videoHeight/t.videoWidth;isNaN(o)?(A=window.innerWidth,k=window.innerHeight,B=0,x=0,e.style="top: "+B+"px; left: "+x+"px; width: "+A+"px; height: "+k+"px; cursor: "+P+"; "+I):n<i?(A=Math.floor(window.innerHeight/o),k=window.innerHeight,B=0,x=Math.floor(.5*(window.innerWidth-A)),e.style="top: "+B+"px; left: "+x+"px; width: "+A+"px; height: "+k+"px; cursor: "+P+"; "+I):(A=window.innerWidth,k=Math.floor(window.innerWidth*o),B=Math.floor(.5*(window.innerHeight-k)),x=0,e.style="top: "+B+"px; left: "+x+"px; width: "+A+"px; height: "+k+"px; cursor: "+P+"; "+I)}(t):function(e){let t=e.getElementsByTagName("VIDEO");if(t.length>0){A=t[0].videoWidth,k=t[0].videoHeight;let n=Math.floor(.5*(window.innerHeight-k)),i=Math.floor(.5*(window.innerWidth-A));B=n>0?n:0,x=i>0?i:0,e.style="top: "+B+"px; left: "+x+"px; width: "+A+"px; height: "+k+"px; cursor: "+P+"; "+I}}(t):function(e){e.getElementsByTagName("VIDEO"),e.style="top: 0px; left: 0px; width: "+A+"px; height: "+k+"px; cursor: "+P+"; "+I}(t),N(t)}function N(e){e.getBoundingClientRect(),function(){let e=document.getElementById("player"),t=e.getElementsByTagName("video");if(e&&t.length>0){let n=e.clientHeight/e.clientWidth,i=t[0].videoHeight/t[0].videoWidth;if(n>i){let t=n/i;q=(n,i)=>{let o=n/e.clientWidth,a=t*(i/e.clientHeight-.5)+.5;return o<0||o>1||a<0||a>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*o,y:65536*a}},G=(n,i)=>{let o=(i/65536-.5)/t+.5;return{x:n/65536*e.clientWidth,y:o*e.clientHeight}},X=(n,i)=>({x:32767*(n/(.5*e.clientWidth)),y:32767*(t*i/(.5*e.clientHeight))})}else{let t=i/n;q=(n,i)=>{let o=t*(n/e.clientWidth-.5)+.5,a=i/e.clientHeight;return o<0||o>1||a<0||a>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*o,y:65536*a}},G=(n,i)=>{let o=i/65536;return{x:((n/65536-.5)/t+.5)*e.clientWidth,y:o*e.clientHeight}},X=(n,i)=>({x:32767*(t*n/(.5*e.clientWidth)),y:32767*(i/(.5*e.clientHeight))})}}}(),z()}function $(){if((new Date).getTime()-c>1e3){if(!document.getElementById("player"))return;Q({PageId:"0",ExcuteName:"SetResolutionSize",x:window.innerWidth,y:window.innerHeight}),console.log(`%ctrue 宽度x:${window.innerWidth},高度y:${window.innerHeight}`,"display: inline-block ; border: 3px solid red ; border-radius: 7px ; padding: 10px ; margin: 20px ;"),c=(new Date).getTime()}else console.log("Resizing too often - skipping"),clearTimeout(s),s=setTimeout($,1e3)}function J(e){clearTimeout(H),H=setTimeout((function(){F()}),500)}const Y={IFrameRequest:0,RequestQualityControl:1,MaxFpsRequest:2,AverageBitrateRequest:3,StartStreaming:4,StopStreaming:5,LatencyTest:6,RequestInitialSettings:7,UIInteraction:50,Command:51,KeyDown:60,KeyUp:61,KeyPress:62,MouseEnter:70,MouseLeave:71,MouseDown:72,MouseUp:73,MouseMove:74,MouseWheel:75,TouchStart:80,TouchEnd:81,TouchMove:82,GamepadButtonPressed:90,GamepadButtonReleased:91,GamepadAnalog:92};function Q(e){!function(e,t){let n=JSON.stringify(t),i=new DataView(new ArrayBuffer(3+2*n.length)),o=0;i.setUint8(o,e),o++,i.setUint16(o,n.length,!0),o+=2;for(var a=0;a<n.length;a++)i.setUint16(o,n.charCodeAt(a),!0),o+=2;w(i.buffer)}(Y.UIInteraction,e)}let q,X,G;function K(e,t,n,i){let o=q(e,t),a=X(n,i),s=new DataView(new ArrayBuffer(9));s.setUint8(0,Y.MouseMove),s.setUint16(1,o.x,!0),s.setUint16(3,o.y,!0),s.setInt16(5,a.x,!0),s.setInt16(7,a.y,!0),w(s.buffer)}function Z(e,t,n){let i=q(t,n),o=new DataView(new ArrayBuffer(6));o.setUint8(0,Y.MouseDown),o.setUint8(1,e),o.setUint16(2,i.x,!0),o.setUint16(4,i.y,!0),w(o.buffer)}function _(e,t,n){let i=q(t,n),o=new DataView(new ArrayBuffer(6));o.setUint8(0,Y.MouseUp),o.setUint8(1,e),o.setUint16(2,i.x,!0),o.setUint16(4,i.y,!0),w(o.buffer)}function ee(e,t,n){let i=q(t,n),o=new DataView(new ArrayBuffer(7));o.setUint8(0,Y.MouseWheel),o.setInt16(1,e,!0),o.setUint16(3,i.x,!0),o.setUint16(5,i.y,!0),w(o.buffer)}const te=0,ne=1,ie=2,oe=3,ae=4,se=1,re=2,le=4,ce=8,de=16;function ge(e,t,n){e&se&&_(te,t,n),e&re&&_(ie,t,n),e&le&&_(ne,t,n),e&ce&&_(oe,t,n),e&de&&_(ae,t,n)}function fe(e,t,n){e&se&&Z(te,t,n),e&re&&Z(ie,t,n),e&le&&Z(ne,t,n),e&ce&&Z(oe,t,n),e&de&&Z(ae,t,n)}function me(e){let t=e.width/2,n=e.height/2;function i(){document.pointerLockElement===e||document.mozPointerLockElement===e?(console.log("Pointer locked"),document.addEventListener("mousemove",o,!1)):(console.log("The pointer lock status is now unlocked"),document.removeEventListener("mousemove",o,!1))}function o(e){t+=e.movementX,n+=e.movementY,t>A&&(t-=A),n>k&&(n-=k),t<0&&(t=A+t),n<0&&(n=k-n),K(t,n,e.movementX,e.movementY)}e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock,e.onclick=function(){e.requestPointerLock()},document.addEventListener("pointerlockchange",i,!1),document.addEventListener("mozpointerlockchange",i,!1),e.onmousedown=function(e){Z(e.button,t,n)},e.onmouseup=function(e){_(e.button,t,n)},e.onmousewheel=function(e){ee(e.wheelDelta,t,n)},e.pressMouseButtons=function(e){fe(e.buttons,t,n)},e.releaseMouseButtons=function(e){ge(e.buttons,t,n)}}function he(e){return e>=112&&e<=123||9===e}const pe=8,ye=16,ve=17,we=18,Se=253,Te=254,be=255;function Ce(e){return e.keyCode===ye&&"ShiftRight"===e.code?Se:e.keyCode===ve&&"ControlRight"===e.code?Te:e.keyCode===we&&"AltRight"===e.code?be:e.keyCode}function Me(){j(),F(),setTimeout((()=>{!function(){if(window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void alert("Your browser doesn't support WebSocket");o=new WebSocket(`ws://${Ee}/`),o.onmessage=function(e){console.log(`WebSocket事件参数 ${e.data}`);let t=JSON.parse(e.data);var n,o;"config"===t.type?function(e){let t=R(document.getElementById("player"),e);switch(F(),L){case W:!function(e){console.log("%c当前开启HoveringMouse","color: tomato"),P=i?.cursorStyle??"none",e.onmousemove=function(e){K(e.offsetX,e.offsetY,e.movementX,e.movementY),e.preventDefault()},e.onmousedown=function(e){Z(e.button,e.offsetX,e.offsetY),e.preventDefault()},e.onmouseup=function(e){_(e.button,e.offsetX,e.offsetY),e.preventDefault()},e.oncontextmenu=function(e){_(e.button,e.offsetX,e.offsetY),e.preventDefault()},"onmousewheel"in e?e.onmousewheel=function(e){ee(e.wheelDelta,e.offsetX,e.offsetY),e.preventDefault()}:e.addEventListener("DOMMouseScroll",(function(e){ee(-120*e.detail,e.offsetX,e.offsetY),e.preventDefault()}),!1),e.pressMouseButtons=function(e){fe(e.buttons,e.offsetX,e.offsetY)},e.releaseMouseButtons=function(e){ge(e.buttons,e.offsetX,e.offsetY)}}(t);break;case O:me(t);break;default:console.log(`ERROR: Unknown control scheme ${L}`),me(t)}}(t):"playerCount"===t.type?function(e){let t=document.getElementById("kick-other-players-button");t&&(t.value=`Kick (${e})`)}(t.count-1):"answer"===t.type?(o=t,a.receiveAnswer(o),a.onAggregatedStats=e=>{},a.aggregateStats(1e3),a.latencyTestTimings.OnAllLatencyTimingsReady=function(e){if(!e.BrowserReceiptTimeMs)return;let t=e.BrowserReceiptTimeMs-e.TestStartTimeMs,n=0==e.UEPreEncodeTimeMs||0==e.UEPreCaptureTimeMs?"???":e.UEPostEncodeTimeMs-e.UEPreCaptureTimeMs,i=e.UEPostCaptureTimeMs-e.UEPreCaptureTimeMs,o=e.UEPostEncodeTimeMs-e.UEPreEncodeTimeMs,a=e.UETransmissionTimeMs-e.UEReceiptTimeMs,s=t-a,r=t-s-a,l=null,c=null;e.FrameDisplayDeltaTimeMs&&e.BrowserReceiptTimeMs&&(l=e.FrameDisplayDeltaTimeMs+t,c=l-s-a);let d="";d+=`<div>Net latency RTT (ms): ${s}</div>`,d+=`<div>UE Capture+Encode (ms): ${n}</div>`,d+=`<div>UE Capture (ms): ${i}</div>`,d+=`<div>UE Encode (ms): ${o}</div>`,d+=`<div>Total UE latency (ms): ${a}</div>`,d+=`<div>Browser send latency (ms): ${r}</div>`,d+=e.FrameDisplayDeltaTimeMs&&e.BrowserReceiptTimeMs?`<div>Browser receive latency (ms): ${e.FrameDisplayDeltaTimeMs}</div>`:"",d+=c?`<div>Total browser latency (ms): ${c}</div>`:"",d+=`<div>Total latency (excluding browser) (ms): ${t}</div>`,d+=l?`<div>Total latency (ms): ${l}</div>`:"",document.getElementById("LatencyStats").innerHTML=d}):"iceCandidate"===t.type?(n=t.candidate,a&&a.handleCandidateFromServer(n)):console.log(`invalid SS message type: ${t.type}`)},o.onerror=function(e){console.log(`WS error: ${JSON.stringify(e)}`)},o.onclose=function(e){console.log(`WS closed: ${JSON.stringify(e.code)} - ${e.reason}`),o=void 0;let t=document.getElementById("player");a&&(t.removeChild(a.video),a.close(),a=void 0),h(`已断开连接 ${e.reason}`),Re()}}()}),1e3),v()}let Ee="localhost:80";function De(e,t,n={}){console.log("ws to signal server: ",e),i=Object.assign(i,n),Ee=e,r=t,window.addEventListener("resize",F,!0),window.addEventListener("orientationchange",J),function(){u=document.createElement("div"),u.id="freezeFrameOverlay",u.style.display="none",u.style.pointerEvents="none",u.style.position="absolute",u.style.zIndex="20";let e=document.createElement("img");e.style.position="absolute",u.appendChild(e)}(),document.onkeydown=function(e){w(new Uint8Array([Y.KeyDown,Ce(e),e.repeat]).buffer),e.keyCode===pe&&document.onkeypress({charCode:pe}),he(e.keyCode)&&e.preventDefault()},document.onkeyup=function(e){w(new Uint8Array([Y.KeyUp,Ce(e)]).buffer),he(e.keyCode)&&e.preventDefault()},document.onkeypress=function(e){let t=new DataView(new ArrayBuffer(3));t.setUint8(0,Y.KeyPress),t.setUint16(1,e.charCode,!0),w(t.buffer)},Me()}function Ue(e){if("string"==typeof e)try{let t=JSON.parse(e);return!("object"!=typeof t||!t)}catch(e){return!1}return!1}var Re=null;const Ae=(e,t,n={isJson:!1,isLog:!1})=>{n.isJson&&"object"==typeof t&&(t=JSON.stringify(t)),n.isLog&&console.log("通知ue->事件名称：",e,"参数："+t),window.ue4(e,t)},ke=(e,t,n={isLog:!1})=>{n.isLog&&console.log("通知ue->事件名称：",e,"参数："+t),function(e,t,n){let i={eventName:e,eventParam:t};console.log("send:",i),d.set(e,n),Q(i)}(e,t)},Be=(e,t,n={isLog:!1})=>{window.ue.interface[e]=i=>{n.isLog&&console.log("接收ue->事件名称：",e,"参数："+i),function(e){if("string"==typeof e)try{let t=JSON.parse(e);return!("object"!=typeof t||!t)}catch(e){return!1}return!1}(i)&&(i=JSON.parse(i)),t(i)}};const xe=(e,t,n={isLog:!1})=>{console.log("PS注册事件：",e),function(e,t){d.set(e,t)}(e,(i=>{n.isLog&&console.log("接收ue->事件名称：",e,"参数："+i),t(i)}))};let Ie=null,Pe="ue_engine";const Oe=e=>{Pe=e,Ie(Pe),console.log("前端更改了当前交互环境",e)},We=function(e){Ie=e},He=(e,t,n)=>"ue_engine"===Pe?Ae(e,t,n):ke(e,t,n),Le=(e,t,n)=>"ue_engine"===Pe?Be(e,t,n):xe(e,t,n),Ve=function(){Oe("pixel_stream"),De(...arguments)},je=function(){console.log("触发了关闭UE像素流",o),o&&o.close(),a&&(a.close(),a=void 0)},ze=function(e){Re=e},Fe=function(e){d.delete(e)};export{Pe as UE_ENV,We as onSetEnv,Be as pcRegister,Ae as pcSend,je as psClose,ze as psDisconnect,Ve as psLoad,xe as psRegister,ke as psSend,Fe as psUnregister,Oe as setEnv,Le as ueRegister,He as ueSend};
