var e,t;function n(e){e=void 0!==e?e:{};var t=this;console.log("在webRtcPlayer函数中运行","parOptions:",e,"\n","window.location:",window.location,"\n","self:",t),this.cfg=void 0!==e.peerConnectionOptions?e.peerConnectionOptions:{},this.cfg.sdpSemantics="unified-plan",this.cfg.offerExtmapAllowMixed=!1,this.pcClient=null,this.dcClient=null,this.tnClient=null,this.sdpConstraints={offerToReceiveAudio:1,offerToReceiveVideo:1,voiceActivityDetection:!1},this.dataChannelOptions={ordered:!0},this.startVideoMuted=void 0!==e.startVideoMuted&&e.startVideoMuted,this.autoPlayAudio=void 0===e.autoPlayAudio||e.autoPlayAudio;const n=new URLSearchParams(window.location.search);this.useMic=n.has("useMic"),this.useMic||console.log("Microphone access is not enabled. Pass ?useMic in the url to enable it.");let i="localhost"===location.hostname||"127.0.0.1"===location.hostname,o="https:"===location.protocol;!this.useMic||i||o||(this.useMic=!1,console.error("Microphone access in the browser will not work if you are not on HTTPS or localhost. Disabling mic access."),console.error("For testing you can enable HTTP microphone access Chrome by visiting chrome://flags/ and enabling 'unsafely-treat-insecure-origin-as-secure'")),this.latencyTestTimings={TestStartTimeMs:null,UEReceiptTimeMs:null,UEPreCaptureTimeMs:null,UEPostCaptureTimeMs:null,UEPreEncodeTimeMs:null,UEPostEncodeTimeMs:null,UETransmissionTimeMs:null,BrowserReceiptTimeMs:null,FrameDisplayDeltaTimeMs:null,Reset:function(){this.TestStartTimeMs=null,this.UEReceiptTimeMs=null,this.UEPreCaptureTimeMs=null,this.UEPostCaptureTimeMs=null,this.UEPreEncodeTimeMs=null,this.UEPostEncodeTimeMs=null,this.UETransmissionTimeMs=null,this.BrowserReceiptTimeMs=null,this.FrameDisplayDeltaTimeMs=null},SetUETimings:function(e){this.UEReceiptTimeMs=e.ReceiptTimeMs,this.UEPreCaptureTimeMs=e.PreCaptureTimeMs,this.UEPostCaptureTimeMs=e.PostCaptureTimeMs,this.UEPreEncodeTimeMs=e.PreEncodeTimeMs,this.UEPostEncodeTimeMs=e.PostEncodeTimeMs,this.UETransmissionTimeMs=e.TransmissionTimeMs,this.BrowserReceiptTimeMs=Date.now(),this.OnAllLatencyTimingsReady(this)},SetFrameDisplayDeltaTime:function(e){null==this.FrameDisplayDeltaTimeMs&&(this.FrameDisplayDeltaTimeMs=Math.round(e),this.OnAllLatencyTimingsReady(this))},OnAllLatencyTimingsReady:function(e){}},this.createWebRtcVideo=function(){var e=document.getElementById("streamingVideo");if(e.muted="muted",e.disablepictureinpicture=!0,e.addEventListener("loadedmetadata",(function(e){t.onVideoInitialised&&t.onVideoInitialised()}),!0),"requestVideoFrameCallback"in HTMLVideoElement.prototype){const n=(i,o)=>{if(o.receiveTime&&o.expectedDisplayTime){const e=o.presentationTime-o.receiveTime;t.aggregatedStats.receiveToCompositeMs=e}e.requestVideoFrameCallback(n)};e.requestVideoFrameCallback(n)}return e},this.video=this.createWebRtcVideo();let a=function(e){console.info("signaling state change:",e)},s=function(e){console.info("ice connection state change:",e)},r=function(e){console.info("ice gathering state change:",e)},c=function(e){return console.log("handleOnTrack",e.streams),console.log("🚀 🚀 🚀 🚀 🚀 🚀 e",e),console.log("🚀 🚀 🚀 🚀 🚀 🚀 self.video.srcObject ",t.video,t.video.srcObject),e.track&&console.log("Got track - "+e.track.kind+" id="+e.track.id+" readyState="+e.track.readyState),"audio"==e.track.kind?(console.log("🚀 ~ file: webRtcPlayer.js:207 ~ handleOnTrack ~ e.track.kind",e.track),void l(e.streams[0])):("video"==e.track.kind&&(t.video.srcObject,e.streams[0]),t.video.srcObject=e.streams[0],void console.log("Set video source from video track ontrack."))},l=function(e){if(t.video.srcObject!=e&&t.video.srcObject&&t.video.srcObject!==e){let n=document.createElement("Audio");if(n.srcObject=e,console.log("self ",t),!t.autoPlayAudio){let e=function(){n.play(),t.video.removeEventListener("click",e)};t.video.addEventListener("click",e)}console.log("Created new audio element to play seperate audio stream.")}},d=function(e){console.log("ICE candidate",e),e.candidate&&e.candidate.candidate&&t.onWebRtcCandidate(e.candidate)},u=function(e){e.sdp=e.sdp.replace("useinbandfec=1","useinbandfec=1;stereo=1;sprop-maxcapturerate=48000")};this.setVideoEnabled=function(e){t.video.srcObject.getTracks().forEach((t=>t.enabled=e))},this.startLatencyTest=function(e){t.video&&(t.latencyTestTimings.Reset(),t.latencyTestTimings.TestStartTimeMs=Date.now(),e(t.latencyTestTimings.TestStartTimeMs))},this.handleCandidateFromServer=function(e){console.log("ICE candidate: ",e);let n=new RTCIceCandidate(e);t.pcClient.addIceCandidate(n).then((e=>{console.log("ICE candidate successfully added")}))},this.createOffer=function(){t.pcClient&&(console.log("Closing existing PeerConnection"),t.pcClient.close(),t.pcClient=null),t.pcClient=new RTCPeerConnection(t.cfg),async function(e){if(e.addTransceiver("video",{direction:"recvonly"}),t.useMic){let n=!!t.useMic&&{autoGainControl:!1,channelCount:1,echoCancellation:!1,latency:0,noiseSuppression:!1,sampleRate:16e3,volume:1};const i=await navigator.mediaDevices.getUserMedia({video:!1,audio:n});if(i)for(const t of i.getTracks())t.kind&&"audio"==t.kind&&e.addTransceiver(t,{direction:"sendrecv"});else e.addTransceiver("audio",{direction:"recvonly"})}else e.addTransceiver("audio",{direction:"recvonly"})}(t.pcClient).finally((function(){var e;(e=t.pcClient).SetBitrate&&console.log("Hurray! there's RTCPeerConnection.SetBitrate function"),e.onsignalingstatechange=a,e.oniceconnectionstatechange=s,e.onicegatheringstatechange=r,e.ontrack=c,e.onicecandidate=d,t.dcClient=function(e,n,i){try{let o=e.createDataChannel(n,i);return console.log(`Created datachannel (${n})`),o.binaryType="arraybuffer",o.onopen=function(e){console.log(`data channel (${n}) connect`),t.onDataChannelConnected&&t.onDataChannelConnected()},o.onclose=function(e){console.log(`data channel (${n}) closed`)},o.onmessage=function(e){t.onDataChannelMessage&&t.onDataChannelMessage(e.data)},o}catch(e){return console.warn("No data channel",e),null}}(t.pcClient,"cirrus",t.dataChannelOptions),function(e){e.createOffer(t.sdpConstraints).then((function(n){u(n),e.setLocalDescription(n),t.onWebRtcOffer&&t.onWebRtcOffer(n)}),(function(){console.warn("Couldn't create offer")}))}(t.pcClient)}))},this.receiveAnswer=function(e){console.log("Received answer:"),console.log(e);var n=new RTCSessionDescription(e);t.pcClient.setRemoteDescription(n);let i=t.pcClient.getReceivers();for(let e of i)e.playoutDelayHint=0},this.close=function(){t.pcClient&&(console.log("Closing existing peerClient"),t.pcClient.close(),t.pcClient=null),t.aggregateStatsIntervalId&&clearInterval(t.aggregateStatsIntervalId)},this.send=function(e){t.dcClient&&"open"==t.dcClient.readyState&&t.dcClient.send(e)},this.getStats=function(e){t.pcClient&&e&&t.pcClient.getStats(null).then((t=>{e(t)}))},this.aggregateStats=function(e){let n=(t.aggregatedStats||(t.aggregatedStats={}),function(e){let n={};e.forEach((e=>{"inbound-rtp"!=e.type||e.isRemote||"video"!=e.mediaType&&!e.id.toLowerCase().includes("video")||(n.timestamp=e.timestamp,n.bytesReceived=e.bytesReceived,n.framesDecoded=e.framesDecoded,n.packetsLost=e.packetsLost,n.bytesReceivedStart=t.aggregatedStats&&t.aggregatedStats.bytesReceivedStart?t.aggregatedStats.bytesReceivedStart:e.bytesReceived,n.framesDecodedStart=t.aggregatedStats&&t.aggregatedStats.framesDecodedStart?t.aggregatedStats.framesDecodedStart:e.framesDecoded,n.timestampStart=t.aggregatedStats&&t.aggregatedStats.timestampStart?t.aggregatedStats.timestampStart:e.timestamp,t.aggregatedStats&&t.aggregatedStats.timestamp&&(t.aggregatedStats.bytesReceived&&(n.bitrate=8*(n.bytesReceived-t.aggregatedStats.bytesReceived)/(n.timestamp-t.aggregatedStats.timestamp),n.bitrate=Math.floor(n.bitrate),n.lowBitrate=t.aggregatedStats.lowBitrate&&t.aggregatedStats.lowBitrate<n.bitrate?t.aggregatedStats.lowBitrate:n.bitrate,n.highBitrate=t.aggregatedStats.highBitrate&&t.aggregatedStats.highBitrate>n.bitrate?t.aggregatedStats.highBitrate:n.bitrate),t.aggregatedStats.bytesReceivedStart&&(n.avgBitrate=8*(n.bytesReceived-t.aggregatedStats.bytesReceivedStart)/(n.timestamp-t.aggregatedStats.timestampStart),n.avgBitrate=Math.floor(n.avgBitrate)),t.aggregatedStats.framesDecoded&&(n.framerate=(n.framesDecoded-t.aggregatedStats.framesDecoded)/((n.timestamp-t.aggregatedStats.timestamp)/1e3),n.framerate=Math.floor(n.framerate),n.lowFramerate=t.aggregatedStats.lowFramerate&&t.aggregatedStats.lowFramerate<n.framerate?t.aggregatedStats.lowFramerate:n.framerate,n.highFramerate=t.aggregatedStats.highFramerate&&t.aggregatedStats.highFramerate>n.framerate?t.aggregatedStats.highFramerate:n.framerate),t.aggregatedStats.framesDecodedStart&&(n.avgframerate=(n.framesDecoded-t.aggregatedStats.framesDecodedStart)/((n.timestamp-t.aggregatedStats.timestampStart)/1e3),n.avgframerate=Math.floor(n.avgframerate)))),"track"!=e.type||"video_label"!=e.trackIdentifier&&"video"!=e.kind||(n.framesDropped=e.framesDropped,n.framesReceived=e.framesReceived,n.framesDroppedPercentage=e.framesDropped/e.framesReceived*100,n.frameHeight=e.frameHeight,n.frameWidth=e.frameWidth,n.frameHeightStart=t.aggregatedStats&&t.aggregatedStats.frameHeightStart?t.aggregatedStats.frameHeightStart:e.frameHeight,n.frameWidthStart=t.aggregatedStats&&t.aggregatedStats.frameWidthStart?t.aggregatedStats.frameWidthStart:e.frameWidth),"candidate-pair"==e.type&&e.hasOwnProperty("currentRoundTripTime")&&0!=e.currentRoundTripTime&&(n.currentRoundTripTime=e.currentRoundTripTime)})),t.aggregatedStats.receiveToCompositeMs&&(n.receiveToCompositeMs=t.aggregatedStats.receiveToCompositeMs,t.latencyTestTimings.SetFrameDisplayDeltaTime(t.aggregatedStats.receiveToCompositeMs)),t.aggregatedStats=n,t.onAggregatedStats&&t.onAggregatedStats(n)});t.aggregateStatsIntervalId=setInterval((()=>{t.getStats(n)}),e)}}window.ue4=(e=function(e,t){if("function"!=typeof e)return"";var n="10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}));return ue.interface[n]=e,setTimeout((function(){delete ue.interface[n]}),1e3*Math.max(1,parseInt(t)||0)),n},"object"!=typeof window.ue&&(window.ue={}),"object"!=typeof ue.interface||"function"!=typeof ue.interface.broadcast?(ue.interface={},function(t,n,i,o){var a,s;"string"==typeof t&&("function"==typeof n&&(o=i,i=n,n=null),a=[t,"",e(i,o)],void 0!==n&&(a[1]=n),s=encodeURIComponent(JSON.stringify(a)),"object"==typeof history&&"function"==typeof history.pushState?(history.pushState({},"","#"+s),history.pushState({},"","#"+encodeURIComponent("[]"))):(document.location.hash=s,document.location.hash=encodeURIComponent("[]")))}):(t=ue.interface,ue.interface={},function(n,i,o,a){var s;"string"==typeof n&&("function"==typeof i&&(a=o,o=i,i=null),s=e(o,a),void 0!==i?t.broadcast(n,JSON.stringify(i),s):t.broadcast(n,"",s))})),document.createEvent("KeyboardEvent").initKeyboardEvent;let i,o=null;let a,s,r,c=(new Date).getTime(),l=new Map,d=null,u=!0,g={receiving:!1,size:0,jpeg:void 0,height:0,width:0,valid:!1};function f(e,t,n){let i=document.getElementById("videoPlayOverlay");if(!i){let e=document.getElementById("player");i=document.createElement("div"),i.style.position="absolute",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.id="videoPlayOverlay",e.appendChild(i)}for(;i.lastChild;)i.removeChild(i.lastChild);t&&i.appendChild(t),n&&i.addEventListener("click",(function e(t){n(t),i.removeEventListener("click",e)}));let o=i.classList;for(let e=o.length-1;e>=0;e--)o.remove(o[e]);i.classList.add(e)}function m(e){let t=document.createElement("div");t.id="messageOverlay",t.innerHTML=e||"",f("textDisplayState",t)}function h(){o&&o.video?(o.video.muted=!0,o.autoPlayAudio=!1,o.video.play().catch((function(e){console.error(e),console.log("Browser does not support autoplaying video without interaction - to resolve this we are going to show the play button overlay."),p()})),v(new Uint8Array([J.RequestInitialSettings]).buffer),v(new Uint8Array([J.RequestQualityControl]).buffer),A(),y()):console.error("Could not player video stream because webRtcPlayerObj.video was not valid.")}function p(){let e=document.createElement("img");e.id="playButton",e.src="../assets/image/play-icon.png",e.style.position="abs",e.style.width="60px",e.style.height="60px",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.zIndex="100",e.style.cursor="pointer",e.style.transform="translate(-50%, -50%)",e.alt="Start Streaming",f("clickableState",e,(e=>{h()})),u=!1}function y(){f("hiddenState")}function v(e){o&&o.send(e)}const w=0,T=1,S=2,b=3,M=4,C=5,E=6,D=7;function R(e,t){function a(e){g.receiving||(g.receiving=!0,g.valid=!1,g.size=0,g.jpeg=void 0),g.size=new DataView(e.slice(1,5).buffer).getInt32(0,!0);let t=e.slice(5);if(g.jpeg){let e=new Uint8Array(g.jpeg.length+t.length);e.set(g.jpeg,0),e.set(t,g.jpeg.length),g.jpeg=e}else g.jpeg=t,g.receiving=!0,console.log(`received first chunk of freeze frame: ${g.jpeg.length}/${g.size}`);g.jpeg.length===g.size?(g.receiving=!1,g.valid=!0,console.log(`received complete freeze frame ${g.size}`),function(){let e=btoa(g.jpeg.reduce(((e,t)=>e+String.fromCharCode(t)),"")),t=document.getElementById("freezeFrameOverlay").childNodes[0];t.src="data:image/jpeg;base64,"+e,t.onload=function(){g.height=t.naturalHeight,g.width=t.naturalWidth,j(),u?(p(),$()):A(),o.setVideoEnabled(!1)}}()):g.jpeg.length>g.size&&(console.error(`received bigger freeze frame than advertised: ${g.jpeg.length}/${g.size}`),g.jpeg=void 0,g.receiving=!1)}return o=new n(t),e.appendChild(o.video),e.appendChild(d),o.onWebRtcOffer=function(e){if(i&&1===i.readyState){let t=JSON.stringify(e);console.log(`-> SS: offer:\n${t}`),i.send(t)}},o.onWebRtcCandidate=function(e){i&&1===i.readyState&&(console.log(`-> SS: iceCandidate\n${JSON.stringify(e,void 0,4)}`),i.send(JSON.stringify({type:"iceCandidate",candidate:e})))},o.onVideoInitialised=function(){i&&1===i.readyState&&(u?(p(),$()):($(),h()))},o.onDataChannelConnected=function(){i&&1===i.readyState&&(m("WebRTC connected, waiting for video"),s&&s(),o.video&&o.video.srcObject&&o.onVideoInitialised&&o.onVideoInitialised())},o.onDataChannelMessage=function(e){let t=new Uint8Array(e);if(t[0]===w){let e=0!==t[1];console.log("Received quality controller message, will control quality: "+e)}else if(t[0]===T){!function(e){if(console.log("接收:",e),console.log(Ee(e),"isJson"),Ee(e)){let t=JSON.parse(e),n=t.eventName,i=l.get(n);i&&(console.log("callback",i),i(t.eventParam))}}(new TextDecoder("utf-16").decode(e.slice(1)))}else if(t[0]===S){let t=new TextDecoder("utf-16").decode(e.slice(1));console.log(t);let n=JSON.parse(t);"onScreenKeyboard"===n.command&&function(e){if(e.showOnScreenKeyboard){r.classList.remove("hiddenState");let t=K(e.x,e.y);r.style.top=t.y.toString()+"px",r.style.left=(t.x-40).toString()+"px"}}(n)}else if(t[0]===b)a(t);else if(t[0]===M)V();else if(t[0]===C)new TextDecoder("utf-16").decode(e.slice(1));else if(t[0]==E){let t=new TextDecoder("utf-16").decode(e.slice(1));console.log("Got latency timings from UE."),console.log(t);let n=JSON.parse(t);o&&o.latencyTestTimings.SetUETimings(n)}else t[0]==D||console.error(`unrecognized data received, packet ID ${t[0]}`)},function(e){if(!e)return;(function(e){e.onmouseenter=function(t){let n=new DataView(new ArrayBuffer(1));n.setUint8(0,J.MouseEnter),v(n.buffer),e.pressMouseButtons(t)},e.onmouseleave=function(t){let n=new DataView(new ArrayBuffer(1));n.setUint8(0,J.MouseLeave),v(n.buffer),e.releaseMouseButtons(t)}})(e),function(e){let t=[9,8,7,6,5,4,3,2,1,0],n={};function i(e){let i=t.pop();void 0===i&&console.log("exhausted touch indentifiers"),n[e.identifier]=i}function o(e){t.push(n[e.identifier]),delete n[e.identifier]}function a(t,i){let o=new DataView(new ArrayBuffer(2+7*i.length));o.setUint8(0,t),o.setUint8(1,i.length);let a=2;for(let t=0;t<i.length;t++){let s=i[t],r=s.clientX-e.offsetLeft,c=s.clientY-e.offsetTop,l=Y(r,c);o.setUint16(a,l.x,!0),a+=2,o.setUint16(a,l.y,!0),a+=2,o.setUint8(a,n[s.identifier],!0),a+=1,o.setUint8(a,255*s.force,!0),a+=1,o.setUint8(a,l.inRange?1:0,!0),a+=1}v(o.buffer)}e.ontouchstart=function(e){for(let t=0;t<e.changedTouches.length;t++)i(e.changedTouches[t]);a(J.TouchStart,e.changedTouches),e.preventDefault()},e.ontouchend=function(e){a(J.TouchEnd,e.changedTouches);for(let t=0;t<e.changedTouches.length;t++)o(e.changedTouches[t]);e.preventDefault()},e.ontouchmove=function(e){a(J.TouchMove,e.touches),e.preventDefault()}}(e)}(o.video),o?(console.log("Creating offer"),o.createOffer()):console.log("WebRTC player not setup, cannot create offer"),o.video}let k,U,x,B,P,O="default";const W=0,I=1;let L,H=I;function A(){g.valid&&(d.classList.add("freezeframeBackground"),d.style.display="block")}function V(){d.style.display="none",g.valid=!1,d.classList.remove("freezeframeBackground"),o&&o.setVideoEnabled(!0)}function j(){if(0!==g.width&&0!==g.height){let e=0,t=0,n=0,i=0,o=document.getElementById("enlarge-display-to-fill-window-tgl"),a=document.getElementById("player");if(null!==o&&o.checked){let o=window.innerWidth/window.innerHeight,a=g.width/g.height;o<a?(e=window.innerWidth,t=Math.floor(window.innerWidth/a),n=Math.floor(.5*(window.innerHeight-t)),i=0):(e=Math.floor(window.innerHeight*a),t=window.innerHeight,n=0,i=Math.floor(.5*(window.innerWidth-e)))}else{let o=a.offsetWidth/a.offsetHeight,s=g.width/g.height;o<s?(e=a.offsetWidth,t=Math.floor(a.offsetWidth/s),n=Math.floor(.5*(a.offsetHeight-t)),i=0):(e=Math.floor(a.offsetHeight*s),t=a.offsetHeight,n=0,i=Math.floor(.5*(a.offsetWidth-e)))}let s=document.getElementById("freezeFrameOverlay").childNodes[0];d.style.width=a.offsetWidth+"px",d.style.height=a.offsetHeight+"px",d.style.left="0px",d.style.top="0px",s.style.width=e+"px",s.style.height=t+"px",s.style.left=i+"px",s.style.top=n+"px"}}function $(e){let t=document.getElementById("player");if(!t)return;if(F(),t.classList.contains("fixed-size"))return void N(t);let n=document.getElementById("enlarge-display-to-fill-window-tgl"),i=window.innerWidth<t.videoWidth||window.innerHeight<t.videoHeight;null!==n?n.checked||i?function(e){let t=e.getElementsByTagName("VIDEO"),n=window.innerHeight/window.innerWidth,i=e.clientHeight/e.clientWidth,o=t.videoHeight/t.videoWidth;isNaN(o)?(k=window.innerWidth,U=window.innerHeight,x=0,B=0,e.style="top: "+x+"px; left: "+B+"px; width: "+k+"px; height: "+U+"px; cursor: "+O+"; "+P):n<i?(k=Math.floor(window.innerHeight/o),U=window.innerHeight,x=0,B=Math.floor(.5*(window.innerWidth-k)),e.style="top: "+x+"px; left: "+B+"px; width: "+k+"px; height: "+U+"px; cursor: "+O+"; "+P):(k=window.innerWidth,U=Math.floor(window.innerWidth*o),x=Math.floor(.5*(window.innerHeight-U)),B=0,e.style="top: "+x+"px; left: "+B+"px; width: "+k+"px; height: "+U+"px; cursor: "+O+"; "+P)}(t):function(e){let t=e.getElementsByTagName("VIDEO");if(t.length>0){k=t[0].videoWidth,U=t[0].videoHeight;let n=Math.floor(.5*(window.innerHeight-U)),i=Math.floor(.5*(window.innerWidth-k));x=n>0?n:0,B=i>0?i:0,e.style="top: "+x+"px; left: "+B+"px; width: "+k+"px; height: "+U+"px; cursor: "+O+"; "+P}}(t):function(e){e.getElementsByTagName("VIDEO"),e.style="top: 0px; left: 0px; width: "+k+"px; height: "+U+"px; cursor: "+O+"; "+P}(t),N(t)}function N(e){e.getBoundingClientRect(),function(){let e=document.getElementById("player"),t=e.getElementsByTagName("video");if(e&&t.length>0){let n=e.clientHeight/e.clientWidth,i=t[0].videoHeight/t[0].videoWidth;if(n>i){let t=n/i;Y=(n,i)=>{let o=n/e.clientWidth,a=t*(i/e.clientHeight-.5)+.5;return o<0||o>1||a<0||a>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*o,y:65536*a}},K=(n,i)=>{let o=(i/65536-.5)/t+.5;return{x:n/65536*e.clientWidth,y:o*e.clientHeight}},X=(n,i)=>({x:32767*(n/(.5*e.clientWidth)),y:32767*(t*i/(.5*e.clientHeight))})}else{let t=i/n;Y=(n,i)=>{let o=t*(n/e.clientWidth-.5)+.5,a=i/e.clientHeight;return o<0||o>1||a<0||a>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*o,y:65536*a}},K=(n,i)=>{let o=i/65536;return{x:((n/65536-.5)/t+.5)*e.clientWidth,y:o*e.clientHeight}},X=(n,i)=>({x:32767*(t*n/(.5*e.clientWidth)),y:32767*(i/(.5*e.clientHeight))})}}}(),j()}function F(){if((new Date).getTime()-c>1e3){if(!document.getElementById("player"))return;q({PageId:"0",ExcuteName:"SetResolutionSize",x:window.innerWidth,y:window.innerHeight}),console.log(`%ctrue 宽度x:${window.innerWidth},高度y:${window.innerHeight}`,"display: inline-block ; border: 3px solid red ; border-radius: 7px ; padding: 10px ; margin: 20px ;"),c=(new Date).getTime()}else console.log("Resizing too often - skipping"),clearTimeout(a),a=setTimeout(F,1e3)}function z(e){clearTimeout(L),L=setTimeout((function(){$()}),500)}const J={IFrameRequest:0,RequestQualityControl:1,MaxFpsRequest:2,AverageBitrateRequest:3,StartStreaming:4,StopStreaming:5,LatencyTest:6,RequestInitialSettings:7,UIInteraction:50,Command:51,KeyDown:60,KeyUp:61,KeyPress:62,MouseEnter:70,MouseLeave:71,MouseDown:72,MouseUp:73,MouseMove:74,MouseWheel:75,TouchStart:80,TouchEnd:81,TouchMove:82,GamepadButtonPressed:90,GamepadButtonReleased:91,GamepadAnalog:92};function q(e){!function(e,t){let n=JSON.stringify(t),i=new DataView(new ArrayBuffer(3+2*n.length)),o=0;i.setUint8(o,e),o++,i.setUint16(o,n.length,!0),o+=2;for(var a=0;a<n.length;a++)i.setUint16(o,n.charCodeAt(a),!0),o+=2;v(i.buffer)}(J.UIInteraction,e)}let Y,X,K;function G(e,t,n,i){let o=Y(e,t),a=X(n,i),s=new DataView(new ArrayBuffer(9));s.setUint8(0,J.MouseMove),s.setUint16(1,o.x,!0),s.setUint16(3,o.y,!0),s.setInt16(5,a.x,!0),s.setInt16(7,a.y,!0),v(s.buffer)}function _(e,t,n){let i=Y(t,n),o=new DataView(new ArrayBuffer(6));o.setUint8(0,J.MouseDown),o.setUint8(1,e),o.setUint16(2,i.x,!0),o.setUint16(4,i.y,!0),v(o.buffer)}function Q(e,t,n){let i=Y(t,n),o=new DataView(new ArrayBuffer(6));o.setUint8(0,J.MouseUp),o.setUint8(1,e),o.setUint16(2,i.x,!0),o.setUint16(4,i.y,!0),v(o.buffer)}function Z(e,t,n){let i=Y(t,n),o=new DataView(new ArrayBuffer(7));o.setUint8(0,J.MouseWheel),o.setInt16(1,e,!0),o.setUint16(3,i.x,!0),o.setUint16(5,i.y,!0),v(o.buffer)}const ee=0,te=1,ne=2,ie=3,oe=4,ae=1,se=2,re=4,ce=8,le=16;function de(e,t,n){e&ae&&Q(ee,t,n),e&se&&Q(ne,t,n),e&re&&Q(te,t,n),e&ce&&Q(ie,t,n),e&le&&Q(oe,t,n)}function ge(e,t,n){e&ae&&_(ee,t,n),e&se&&_(ne,t,n),e&re&&_(te,t,n),e&ce&&_(ie,t,n),e&le&&_(oe,t,n)}function fe(e){let t=e.width/2,n=e.height/2;function i(){document.pointerLockElement===e||document.mozPointerLockElement===e?(console.log("Pointer locked"),document.addEventListener("mousemove",o,!1)):(console.log("The pointer lock status is now unlocked"),document.removeEventListener("mousemove",o,!1))}function o(e){t+=e.movementX,n+=e.movementY,t>k&&(t-=k),n>U&&(n-=U),t<0&&(t=k+t),n<0&&(n=U-n),G(t,n,e.movementX,e.movementY)}e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock,e.onclick=function(){e.requestPointerLock()},document.addEventListener("pointerlockchange",i,!1),document.addEventListener("mozpointerlockchange",i,!1),e.onmousedown=function(e){_(e.button,t,n)},e.onmouseup=function(e){Q(e.button,t,n)},e.onmousewheel=function(e){Z(e.wheelDelta,t,n)},e.pressMouseButtons=function(e){ge(e.buttons,t,n)},e.releaseMouseButtons=function(e){de(e.buttons,t,n)}}function me(e){return e>=112&&e<=123||9===e}const he=8,pe=16,ye=17,ve=18,we=253,Te=254,Se=255;function be(e){return e.keyCode===pe&&"ShiftRight"===e.code?we:e.keyCode===ye&&"ControlRight"===e.code?Te:e.keyCode===ve&&"AltRight"===e.code?Se:e.keyCode}function Me(){V(),$(),setTimeout((()=>{!function(){if(window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void alert("Your browser doesn't support WebSocket");i=new WebSocket(`ws://${Ce}/`),i.onmessage=function(e){console.log(`WebSocket事件参数 ${e.data}`);let t=JSON.parse(e.data);var n,i;"config"===t.type?function(e){let t=R(document.getElementById("player"),e);switch($(),H){case I:!function(e){console.log("%c当前开启HoveringMouse","color: tomato"),O="none",e.onmousemove=function(e){G(e.offsetX,e.offsetY,e.movementX,e.movementY),e.preventDefault()},e.onmousedown=function(e){_(e.button,e.offsetX,e.offsetY),e.preventDefault()},e.onmouseup=function(e){Q(e.button,e.offsetX,e.offsetY),e.preventDefault()},e.oncontextmenu=function(e){Q(e.button,e.offsetX,e.offsetY),e.preventDefault()},"onmousewheel"in e?e.onmousewheel=function(e){Z(e.wheelDelta,e.offsetX,e.offsetY),e.preventDefault()}:e.addEventListener("DOMMouseScroll",(function(e){Z(-120*e.detail,e.offsetX,e.offsetY),e.preventDefault()}),!1),e.pressMouseButtons=function(e){ge(e.buttons,e.offsetX,e.offsetY)},e.releaseMouseButtons=function(e){de(e.buttons,e.offsetX,e.offsetY)}}(t);break;case W:fe(t);break;default:console.log(`ERROR: Unknown control scheme ${H}`),fe(t)}}(t):"playerCount"===t.type?function(e){let t=document.getElementById("kick-other-players-button");t&&(t.value=`Kick (${e})`)}(t.count-1):"answer"===t.type?(i=t,o.receiveAnswer(i),o.onAggregatedStats=e=>{},o.aggregateStats(1e3),o.latencyTestTimings.OnAllLatencyTimingsReady=function(e){if(!e.BrowserReceiptTimeMs)return;let t=e.BrowserReceiptTimeMs-e.TestStartTimeMs,n=0==e.UEPreEncodeTimeMs||0==e.UEPreCaptureTimeMs?"???":e.UEPostEncodeTimeMs-e.UEPreCaptureTimeMs,i=e.UEPostCaptureTimeMs-e.UEPreCaptureTimeMs,o=e.UEPostEncodeTimeMs-e.UEPreEncodeTimeMs,a=e.UETransmissionTimeMs-e.UEReceiptTimeMs,s=t-a,r=t-s-a,c=null,l=null;e.FrameDisplayDeltaTimeMs&&e.BrowserReceiptTimeMs&&(c=e.FrameDisplayDeltaTimeMs+t,l=c-s-a);let d="";d+=`<div>Net latency RTT (ms): ${s}</div>`,d+=`<div>UE Capture+Encode (ms): ${n}</div>`,d+=`<div>UE Capture (ms): ${i}</div>`,d+=`<div>UE Encode (ms): ${o}</div>`,d+=`<div>Total UE latency (ms): ${a}</div>`,d+=`<div>Browser send latency (ms): ${r}</div>`,d+=e.FrameDisplayDeltaTimeMs&&e.BrowserReceiptTimeMs?`<div>Browser receive latency (ms): ${e.FrameDisplayDeltaTimeMs}</div>`:"",d+=l?`<div>Total browser latency (ms): ${l}</div>`:"",d+=`<div>Total latency (excluding browser) (ms): ${t}</div>`,d+=c?`<div>Total latency (ms): ${c}</div>`:"",document.getElementById("LatencyStats").innerHTML=d}):"iceCandidate"===t.type?(n=t.candidate,o&&o.handleCandidateFromServer(n)):console.log(`invalid SS message type: ${t.type}`)},i.onerror=function(e){console.log(`WS error: ${JSON.stringify(e)}`)},i.onclose=function(e){console.log(`WS closed: ${JSON.stringify(e.code)} - ${e.reason}`),i=void 0;let t=document.getElementById("player");o&&(t.removeChild(o.video),o.close(),o=void 0),m(`已断开连接 ${e.reason}`),De()}}()}),1e3),y()}let Ce="localhost:80";function Ee(e){if("string"==typeof e)try{let t=JSON.parse(e);return!("object"!=typeof t||!t)}catch(e){return!1}return!1}var De=null;const Re=(e,t,n={isJson:!0,isLog:!1})=>{n.isJson&&"object"==typeof t&&(t=JSON.stringify(t)),n.isLog&&console.log("通知ue->事件名称：",e,"参数："+t),window.ue4(e,t)},ke=(e,t,n={isLog:!1})=>{n.isLog&&console.log("通知ue->事件名称：",e,"参数："+t),function(e,t,n){let i={eventName:e,eventParam:t};console.log("send:",i),l.set(e,n),q(i)}(e,t)},Ue=(e,t,n={isLog:!1})=>{window.ue.interface[e]=i=>{n.isLog&&console.log("接收ue->事件名称：",e,"参数："+i),function(e){if("string"==typeof e)try{let t=JSON.parse(e);return!("object"!=typeof t||!t)}catch(e){return!1}return!1}(i)&&(i=JSON.parse(i)),t(i)}};const xe=(e,t,n={isLog:!1})=>{console.log("PS注册事件：",e),function(e,t){l.set(e,t)}(e,(i=>{n.isLog&&console.log("接收ue->事件名称：",e,"参数："+i),t(i)}))};let Be=null,Pe="ue_engine";const Oe=e=>{Pe=e,console.log("前端更改了当前交互环境",e)};Ue("setUE_ENV",(e=>{Pe=e,Be&&Be(Pe)}));const We=function(e){Be=e},Ie=(e,t,n)=>"ue_engine"===Pe?Re(e,t,n):ke(e,t,n),Le=(e,t,n)=>"ue_engine"===Pe?Ue(e,t,n):xe(e,t,n),He=function(e,t){console.log("ws to signal server: ",e),Ce=e,s=t,window.addEventListener("resize",$,!0),window.addEventListener("orientationchange",z),function(){d=document.createElement("div"),d.id="freezeFrameOverlay",d.style.display="none",d.style.pointerEvents="none",d.style.position="absolute",d.style.zIndex="20";let e=document.createElement("img");e.style.position="absolute",d.appendChild(e)}(),document.onkeydown=function(e){v(new Uint8Array([J.KeyDown,be(e),e.repeat]).buffer),e.keyCode===he&&document.onkeypress({charCode:he}),me(e.keyCode)&&e.preventDefault()},document.onkeyup=function(e){v(new Uint8Array([J.KeyUp,be(e)]).buffer),me(e.keyCode)&&e.preventDefault()},document.onkeypress=function(e){let t=new DataView(new ArrayBuffer(3));t.setUint8(0,J.KeyPress),t.setUint16(1,e.charCode,!0),v(t.buffer)},Me()},Ae=function(){console.log("触发了关闭UE像素流",i),i&&i.close(),o&&(o.close(),o=void 0)},Ve=function(e){De=e};export{We as onSetEnv,Ue as pcRegister,Re as pcSend,Oe as pcSetEnv,Ae as psClose,Ve as psDisconnect,He as psLoad,xe as psRegister,ke as psSend,Le as ueRegister,Ie as ueSend};
